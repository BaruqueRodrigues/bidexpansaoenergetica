#' Creates Aneel - DEC e FEC Vulnerability
#'
#' This function read the data from Aneel - Indicadores de Continuidade DEC e FEC
#' and summarizes all vulnerabilities at UF, region, and country view per stats.
#'
#' @param dir Directory where the data from Aneel - Indicadores de Continuidade
#' DEC e FEC data has been downloaded.
#'
#' @returns A dataframe
#' @export
#'
#' @examples
#' \dontrun{
#'   aneel_decfec_summarized_by_vulnerability <- create_aneel_perdas_vulnerability(
#'     dir = "data_aneel"
#'   )
#' }
create_aneel_decfec_vulnerability <- function(data_dir = "data_raw/decfec"){

  national_data <- list.files(data_dir,
                              pattern = "Brasil",
                              full.names = T) |>
    purrr::map_df(
      ~ readxl::read_xlsx(.x) |>
        head(-2) |>
        dplyr::mutate(
          geo = "country",
          geo_value = "0"
        ) |>
        dplyr::relocate(
          geo,
          geo_value,
          .before = Ano
        ) |>
        janitor::clean_names()
    ) |>
    dplyr::distinct()

  reg_data <- list.files(data_dir,
                         pattern = "Região",
                         full.names = T) |>
    purrr::map_df(
      ~ readxl::read_xlsx(.x) |>
        head(-2) |>
        dplyr::mutate(
          geo = "region",
          geo_value = dplyr::case_match(Região,
                                        "Norte" ~ "1",
                                        "Nordeste" ~ "2",
                                        "Centro Oeste" ~ "3",
                                        "Sudeste" ~ "4",
                                        "Sul" ~ "5"),
          Ano = as.character(Ano)
        ) |>
        dplyr::relocate(
          geo,
          geo_value,
          .before = Ano
        ) |>
        dplyr::select(-Região) |>
        janitor::clean_names()
    )  |>
    dplyr::distinct()

  uf_data <- list.files(data_dir,
                        pattern = "UF",
                        full.names = T) |>
    purrr::map_df(
      ~ readxl::read_xlsx(.x) |>
        head(-2) |>
        dplyr::mutate(
          geo_value = dplyr::case_match(UF,
                                        "AC" ~ "12",
                                        "AL" ~ "27",
                                        "AP" ~ "16",
                                        "AM" ~ "13",
                                        "BA" ~ "29",
                                        "CE" ~ "23",
                                        "DF" ~ "53",
                                        "ES" ~ "32",
                                        "GO" ~ "52",
                                        "MA" ~ "21",
                                        "MT" ~ "51",
                                        "MS" ~ "50",
                                        "MG" ~ "31",
                                        "PA" ~ "15",
                                        "PB" ~ "25",
                                        "PR" ~ "41",
                                        "PE" ~ "26",
                                        "PI" ~ "22",
                                        "RJ" ~ "33",
                                        "RN" ~ "24",
                                        "RS" ~ "43",
                                        "RO" ~ "11",
                                        "RR" ~ "14",
                                        "SC" ~ "42",
                                        "SP" ~ "35",
                                        "SE" ~ "28",
                                        "TO" ~ "17"
          ),
          geo = "UF",
          Ano = as.character(Ano)
        ) |>
        dplyr::relocate(
          geo,
          geo_value,
          .before = Ano
        ) |>
        dplyr::select(-UF) |>
        janitor::clean_names()
    ) |>
    dplyr::distinct()

  aneel_decfec_summarized_by_vulnerability <- dplyr::bind_rows(national_data,
                                                               reg_data) |>
    dplyr::bind_rows(uf_data) |>
    dplyr::select(
      geo, geo_value, ano, tipo_de_outorga, dec_apurado, dec_limite,
      fec_apurado, fec_limite
    ) |>
    janitor::clean_names() |>
    dplyr::rename(
      aggregation = tipo_de_outorga,
      "DECA" = dec_apurado,
      "DECL" = dec_limite,
      "FECA" = fec_apurado,
      "FECL" = fec_limite
    ) |>
    tidyr::pivot_longer(
      cols = -c(geo, geo_value, ano, aggregation),
      names_to = "variable_id",
      values_to = "stats_value"
    ) |>
    dplyr::mutate(
      database = "aneel_decfec",
      time_period = "year",
      stats_name = "AVG"
    ) |>
    dplyr::rename(
      "time" = ano
    ) |>
    dplyr::relocate(
      database,
      time_period,
      time,
      aggregation,
      geo,
      geo_value,
      variable_id,
      stats_name
    )

}
