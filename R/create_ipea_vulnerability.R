#' Create IPEA Vulnerability
#'
#' This function read the data from IPEA API for IDHM, IDHM Longevidade, IDHM Renda,
#' IDHM Educação and summarizes at UF, region and country view per stats.
#'
#' @returns A dataframe.
#' @export
#'
#' @examples
#' \dontrun{
#'   ipea_summarized_by_vulnerability <- create_ipea_vulnerability()
#' }
create_ipea_vulnerability <- function(){

  # Coletando os dados de IDH da API do IPEA

  # IDH para Brasil e UF
  data_ipea <- ipeadatar::ipeadata(code = "IDHM",
                                   language = "br") |>
    dplyr::filter(date >= '2010-01-01') |>
    dplyr::full_join(
      # IDHM - Longevidade
      ipeadatar::ipeadata(code = "IDHMLO",
                          language = "br") |>
        dplyr::filter(date >= '2010-01-01')
    ) |>
    dplyr::full_join(
      # IDHM - Educação
      ipeadatar::ipeadata(code = "IDHMED",
                          language = "br") |>
        dplyr::filter(date >= '2010-01-01')
    ) |>
    dplyr::full_join(
      # IDHM - Renda
      ipeadatar::ipeadata(code = "IDHMRE",
                          language = "br") |>
        dplyr::filter(date >= '2010-01-01')
    ) |>
    # Selecionando apenas IDH a nível Brasil e Estados, retirando os Municípios
    dplyr::filter(uname %in% c("Brasil", "Estados")) |>
    # Renomeando as colunas
    dplyr::rename(
      "variable_id" = code,
      "stats_value" = value,
      "geo" = uname,
      "geo_value" = tcode,
      "time" = date
    ) |>
    # Recodificando as colunas geo e time
    dplyr::mutate(
      geo = dplyr::recode(geo,
                          Brasil = "country",
                          Estados = "uf"),
      time = lubridate::year(time)
    ) |>
    # Adicionando colunas
    dplyr::mutate(
      database = "ipea",
      time_period = "year",
      stats_name = "AVG",
      geo_value = as.character(geo_value),
      time = as.character(time)
    ) |>
    # Realocando ordem das colunas
    dplyr::relocate(
      database,time_period,time,geo,geo_value,variable_id,stats_name,stats_value
    )

  # IDH para Regiões
  ipea_summarized_by_vulnerability <- data_ipea |>
    # Selecionando o primeiro dígito do geo_code das UF
    tidyr::separate(
      geo_value,
      into = c("geo_value", "uf"),
      sep = 1
    ) |>
    dplyr::mutate(
      geo = "region",
      time = as.character(time)
    ) |>
    dplyr::select(-uf) |>
    dplyr::group_by(database, time_period, time, geo, geo_value, variable_id, stats_name) |>
    # Calculando o IDH para RG
    dplyr::summarise(
      stats_value = mean(stats_value, na.rm = T)
    ) |>
    dplyr::ungroup() |>
    dplyr::filter(geo_value > 0) |>
    dplyr::full_join(data_ipea) |>
    # Adicionando coluna stats_category
    dplyr::mutate(
      stats_category = dplyr::case_when(
        stats_value >= 0 & stats_value < 0.599 ~ "1",
        stats_value >= 0.599 & stats_value < 0.699 ~ "2",
        stats_value >= 0.699 & stats_value < 0.799 ~ "3",
        stats_value >= 0.799 ~ "4"
      )
    )

}
