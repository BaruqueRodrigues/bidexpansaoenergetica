#' Creates ANP - PRECOGLP Vulnerability
#'
#' This function read the data from ANP - Preço do GLP
#' wider data version and summarizes all vulnerabilities
#' at UF, region, and country view per stats.
#'
#' @param anp_precoglp_wider ANP - Preço do GLP dataset transformed in wider data version
#'
#' @returns A dataframe
#' @export
#'
#' @examples
#' \dontrun{
#'   anp_precoglp_wider <- anp_precoglp_transform_wider()
#'   anp_precoglp_summarized_by_vulnerability <- create_anp_precoglp_vulnerability(anp_precoglp_wider)
#' }
create_anp_precoglp_vulnerability <- function(anp_precoglp_wider){

  #Agregação por país:
  preco_glp_br <- anp_precoglp_wider |>
    dplyr::select(
      -uf,
      -region
    ) |>
    dplyr::group_by(
      database,
      time_period,
      time
    ) |>
    dplyr::summarise(
      valor_de_venda_WAVG = sum(valor_de_venda_WSUM)/sum(quantidade_coletas*quantidade_coletas)

    ) |>
    dplyr::mutate(
      geo_value = '0',
      geo = "country"
    )

  #Agregação por região:
  preco_glp_reg <- anp_precoglp_wider |>
    dplyr::rename(
      geo_value = region
    ) |>
    dplyr::select(
      -uf
    ) |>
    dplyr::group_by(
      database,
      time_period,
      time,
      geo_value,
    ) |>
    dplyr::summarise(
      valor_de_venda_WAVG = sum(valor_de_venda_WSUM)/sum(quantidade_coletas*quantidade_coletas)
    ) |>
    dplyr::mutate(
      geo = "region"
    )

  #Agregação por uf:
  preco_glp_uf <- anp_precoglp_wider |>
    dplyr::rename(
      geo_value = uf
    ) |>
    dplyr::select(
      -region
    ) |>
    dplyr::group_by(
      database,
      time_period,
      time,
      geo_value,
    ) |>
    dplyr::summarise(
      valor_de_venda_WAVG = sum(valor_de_venda_WSUM)/sum(quantidade_coletas*quantidade_coletas)
    ) |>
    dplyr::mutate(
      geo = "uf"
    )

  #Tabela final summarizada:
  anp_precoglp_summarized_by_vulnerability <- preco_glp_br |>
    dplyr::bind_rows(preco_glp_reg) |>
    dplyr::bind_rows(preco_glp_uf)|>

    tidyr::pivot_longer(
      cols = -c('database', 'geo', 'geo_value', 'time_period', 'time'),
      names_to = "variable_id",
      values_to = "stats_value"
    ) |>

    dplyr::mutate(
      stats_name = sub(".*_", "", variable_id),
      variable_id = sub("_(?!.*_).*", "", variable_id, perl = TRUE)
    ) |>

    dplyr::select(
      database, time_period, time, geo, geo_value,
      variable_id, stats_name, stats_value
    )

  return (anp_precoglp_summarized_by_vulnerability)

}
