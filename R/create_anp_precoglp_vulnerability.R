#' Creates ANP - PRECOGLP Vulnerability
#'
#' This function read the data from ANP - Preço do GLP compared
#' data and summarizes all vulnerabilities at UF, region, and country view per stats.
#'
#' @param dir Directory where the data from ANP - Preço de GLP data has been downloaded. ("data_raw/preco_glp/")
#' @param file_name .rds File name where the data from ANP - Preço de GLP data has been saved. (default: "preco_glp_2004_2024.rds")
#'
#' @returns A dataframe
#' @export
#'
#' @examples
#' \dontrun{
#'   anp_precoglp_summarized_by_vulnerability <- create_anp_precoglp_vulnerability()
#' }
create_anp_precoglp_vulnerability <- function(dir= "data_raw/preco_glp/", file_name = "preco_glp_2004_2024.rds"){
  file_path <- system.file(dir, file_name, package = "bidexpansaoenergetica")

  #Selecionado e organizando os dados brutos:
  preco_glp <-  readRDS(file_path) |>
    janitor::clean_names() |>
    dplyr::mutate(
      region = dplyr::case_match(regiao_sigla,
                                 "N" ~ "1",
                                 "NE" ~ "2",
                                 "CO" ~ "3",
                                 "SE" ~ "4",
                                 "S" ~ "5"),
      uf = dplyr::case_match(
        `estado_sigla`,
        "RO" ~ "11",
        "AC" ~ "12",
        "AM" ~ "13",
        "RR" ~ "14",
        "PA" ~ "15",
        "AP" ~ "16",
        "TO" ~ "17",
        "MA" ~ "21",
        "PI" ~ "22",
        "CE" ~ "23",
        "RN" ~ "24",
        "PB" ~ "25",
        "PE" ~ "26",
        "AL" ~ "27",
        "SE" ~ "28",
        "BA" ~ "29",
        "MG" ~ "31",
        "ES" ~ "32",
        "RJ" ~ "33",
        "SP" ~ "35",
        "PR" ~ "41",
        "SC" ~ "42",
        "RS" ~ "43",
        "MS" ~ "50",
        "MT" ~ "51",
        "GO" ~ "52",
        "DF" ~ "53"
      ),
      ano = data_da_coleta |> lubridate::dmy() |> lubridate::year()
    )|>
    dplyr::select(
      region,
      uf,
      ano,
      valor_de_venda,
    )

  #Agregação por país:
  preco_glp_br <- preco_glp |>
    dplyr::mutate(
      geo_value = '0'
    ) |>
    dplyr::select(
      -uf,
      -region
    ) |>
    dplyr::group_by(
      geo_value,
      ano
    ) |>
    dplyr::summarise(
      dplyr::across(
        everything(),
        list(
          AVG = ~mean(.x, na.rm = T)
        ),
        .names = "{.col}_{.fn}"
      )
    ) |>
    dplyr::mutate(
      geo = "country"
    )

  #Agregação por região:
  preco_glp_reg <- preco_glp |>
    dplyr::rename(
      geo_value = region
      ) |>
    dplyr::select(
      -uf
      ) |>
    dplyr::group_by(
      geo_value,
      ano
      ) |>
    dplyr::summarise(
      dplyr::across(
        everything(),
        list(
          AVG = ~mean(.x, na.rm = T)
        ),
        .names = "{.col}_{.fn}"
      )
    ) |>
    dplyr::mutate(
      geo = "region"
    )

  #Agregação por uf:
  preco_glp_uf <- preco_glp |>
    dplyr::rename(
      geo_value = uf
    ) |>
    dplyr::select(
      -region
    ) |>
    dplyr::group_by(
      geo_value,
      ano
    ) |>
    dplyr::summarise(
      dplyr::across(
        everything(),
        list(
          AVG = ~mean(.x, na.rm = T)
        ),
        .names = "{.col}_{.fn}"
      )
    ) |>
    dplyr::mutate(
      geo = "uf"
    )


  #Tabela final summarizada:
  anp_precoglp_summarized_by_vulnerability <- preco_glp_br |>
    dplyr::bind_rows(preco_glp_reg) |>
    dplyr::bind_rows(preco_glp_uf)|>

    tidyr::pivot_longer(
      cols = -c('geo', 'geo_value', 'ano'),
      names_to = "variable_id",
      values_to = "stats_value"
    ) |>

    dplyr::mutate(
      stats_name = sub(".*_", "", variable_id),
      variable_id = sub("_(?!.*_).*", "", variable_id, perl = TRUE),
      database = "anp_precoglp",
      time_period = "year") |>

    dplyr::rename(
      time = ano
    ) |>

    dplyr::relocate(
      database, time_period, time, geo, geo_value,
      variable_id, stats_name, stats_value
    )

  return (anp_precoglp_summarized_by_vulnerability)

}
