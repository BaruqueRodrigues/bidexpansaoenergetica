#' Creates MDS - Auxílio Gás Vulnerability
#'
#' This function read the data from MDS - Auxílio Gás and summarizes all vulnerabilities
#' at UF, region, and country view per stats.
#'
#' @param mds_auxgas_wider MDS - Auxílio Gás transformed in wider data version.
#'
#' @returns A dataframe
#' @export
#'
#' @examples
#' \dontrun{
#'   mds_auxgas_summarized_by_vulnerability <- create_mds_auxgas_vulnerability(
#'     dir = "data_mds_auxgas"
#'   )
#' }
create_mds_auxgas_vulnerability <- function(mds_auxgas_wider){

  # Função auxiliar para sumarizar por nível geográfico
  summarize_by_geo <- function(df, geo, geo_value_fn) {
    geo_value_fn <- rlang::as_function(geo_value_fn)

    df %>%
      dplyr::mutate(
        geo = geo,
        geo_value = geo_value_fn(codigo_ibge)
      ) |>
      dplyr::rename(
        time = anomes
      ) |>
      dplyr::select(
        database,
        time_period,
        time,
        geo,
        geo_value,
        qtd_fam_benef_aux_gas,
        qtd_rf_feminino_benef_aux_gas
      ) |>
      dplyr::group_by(
        database, time_period, time, geo, geo_value
      ) |>
      dplyr::summarise(
        dplyr::across(
          dplyr::everything(),
          list(
            AVG = ~mean(.x, na.rm = T),
            SUM = ~sum(.x, na.rm = T)
          ),
          .names = "{.col}.{.fn}"
        )
      ) |>
      dplyr::mutate(
        perc_rf_feminino_aux_gas.AVG = qtd_rf_feminino_benef_aux_gas.AVG/qtd_fam_benef_aux_gas.AVG,
        perc_rf_feminino_aux_gas.SUM = qtd_rf_feminino_benef_aux_gas.SUM/qtd_fam_benef_aux_gas.SUM
      ) |>
      dplyr::ungroup() |>
      tidyr::pivot_longer(
        cols = -c(database, time_period, time, geo, geo_value),
        names_to = c(".value", "stats_name"),
        names_sep = "\\."
      ) |>
      tidyr::pivot_longer(
        cols = -c('database','time_period', 'time', 'geo', 'geo_value', "stats_name"),
        names_to = "variable_id",
        values_to = "stats_value"
      )
  }

  mds_auxgas_br <- summarize_by_geo(mds_auxgas_wider, "country", ~ "0")
  mds_auxgas_reg <- summarize_by_geo(mds_auxgas_wider, "region", ~ stringr::str_extract(., "."))
  mds_auxgas_uf <- summarize_by_geo(mds_auxgas_wider, "uf", ~ stringr::str_extract(., ".."))
  mds_auxgas_mun <- summarize_by_geo(mds_auxgas_wider, "municipality", identity)

  mds_auxgas_summarized_by_vulnerability <- mds_auxgas_br |>
    dplyr::bind_rows(mds_auxgas_reg) |>
    dplyr::bind_rows(mds_auxgas_uf) |>
    dplyr::bind_rows(mds_auxgas_mun)

  mds_auxgas_summarized_by_vulnerability |> dplyr::glimpse()

  return(mds_auxgas_summarized_by_vulnerability)
}
