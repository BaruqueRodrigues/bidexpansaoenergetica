#' Creates MDS - Auxílio Gás Vulnerability
#'
#' This function read the data from MDS - Auxílio Gás and summarizes all vulnerabilities
#' at UF, region, and country view per stats.
#'
#' @param dir Directory where the data from MDS - Auxílio Gás has been downloaded.
#'
#' @returns A dataframe
#' @export
#'
#' @examples
#' \dontrun{
#'   mds_auxgas_summarized_by_vulnerability <- create_mds_auxgas_vulnerability(
#'     dir = "data_mds_auxgas"
#'   )
#' }
create_mds_auxgas_vulnerability <- function(dir = "data_raw/mds_auxgas"){

  mds_auxgas_2021_2024 <- list.files(dir, full.names = T, pattern = ".rds") |>
    readRDS()

  # Calculando os dados a nível Municipio  -----
  mds_auxgas_mun <- mds_auxgas_2021_2024 |>
    dplyr::filter(
      stringr::str_detect(anomes, "\\d{4}12")
    ) |>
    dplyr::mutate(
      database = "mds_auxgas",
      time_period = "year",
      geo = "municipality",
      anomes = stringr::str_extract(anomes, "\\d{4}"),
      codigo_ibge = as.character(codigo_ibge)
    ) |>
    dplyr::rename(
      geo_value = codigo_ibge,
      time = anomes
    ) |>
    dplyr::select(
      database,
      time_period,
      time,
      geo,
      geo_value,
      qtd_fam_benef_aux_gas,
      qtd_rf_feminino_benef_aux_gas
    ) |>
    dplyr::group_by(
      database, time_period, time, geo, geo_value
    ) |>
    dplyr::summarise(
      dplyr::across(
        dplyr::everything(),
        list(
          AVG = ~mean(.x, na.rm = T),
          SUM = ~sum(.x, na.rm = T)
        ),
        .names = "{.col}.{.fn}"
      )
    ) |>
    dplyr::mutate(
      perc_rf_feminino_aux_gas.AVG = qtd_rf_feminino_benef_aux_gas.AVG/qtd_fam_benef_aux_gas.AVG,
      perc_rf_feminino_aux_gas.SUM = qtd_rf_feminino_benef_aux_gas.SUM/qtd_fam_benef_aux_gas.SUM
    ) |>
    dplyr::ungroup() |>
    tidyr::pivot_longer(
      cols = -c(database, time_period, time, geo, geo_value),
      names_to = c(".value", "stats_name"),
      names_sep = "\\."
    ) |>
    tidyr::pivot_longer(
      cols = -c('database','time_period', 'time', 'geo', 'geo_value', "stats_name"),
      names_to = "variable_id",
      values_to = "stats_value"
    )

  # Calculando os dados a nível UF -----
  mds_auxgas_uf <- mds_auxgas_2021_2024 |>
    dplyr::filter(
      stringr::str_detect(anomes, "\\d{4}12")
    ) |>
    dplyr::mutate(
      database = "mds_auxgas",
      time_period = "year",
      geo = "uf",
      anomes = stringr::str_extract(anomes, "\\d{4}"),
      codigo_ibge = stringr::str_extract(codigo_ibge, "..")
    ) |>
    dplyr::rename(
      geo_value = codigo_ibge,
      time = anomes
    ) |>
    dplyr::select(
      database,
      time_period,
      time,
      geo,
      geo_value,
      qtd_fam_benef_aux_gas,
      qtd_rf_feminino_benef_aux_gas
    ) |>
    dplyr::group_by(
      database, time_period, time, geo, geo_value
    ) |>
    dplyr::summarise(
      dplyr::across(
        dplyr::everything(),
        list(
          AVG = ~mean(.x, na.rm = T),
          SUM = ~sum(.x, na.rm = T)
        ),
        .names = "{.col}.{.fn}"
      )
    ) |>
    dplyr::mutate(
      perc_rf_feminino_aux_gas.AVG = qtd_rf_feminino_benef_aux_gas.AVG/qtd_fam_benef_aux_gas.AVG,
      perc_rf_feminino_aux_gas.SUM = qtd_rf_feminino_benef_aux_gas.SUM/qtd_fam_benef_aux_gas.SUM
    ) |>
    dplyr::ungroup() |>
    tidyr::pivot_longer(
      cols = -c(database, time_period, time, geo, geo_value),
      names_to = c(".value", "stats_name"),
      names_sep = "\\."
    ) |>
    tidyr::pivot_longer(
      cols = -c('database','time_period', 'time', 'geo', 'geo_value', "stats_name"),
      names_to = "variable_id",
      values_to = "stats_value"
    )

  # Calculando os dados a nível Region -----
  mds_auxgas_reg <- mds_auxgas_2021_2024 |>
    dplyr::filter(
      stringr::str_detect(anomes, "\\d{4}12")
    ) |>
    dplyr::mutate(
      database = "mds_auxgas",
      time_period = "year",
      geo = "region",
      anomes = stringr::str_extract(anomes, "\\d{4}"),
      codigo_ibge = stringr::str_extract(codigo_ibge, ".")
    ) |>
    dplyr::rename(
      geo_value = codigo_ibge,
      time = anomes
    ) |>
    dplyr::select(
      database,
      time_period,
      time,
      geo,
      geo_value,
      qtd_fam_benef_aux_gas,
      qtd_rf_feminino_benef_aux_gas
    ) |>
    dplyr::group_by(
      database, time_period, time, geo, geo_value
    ) |>
    dplyr::summarise(
      dplyr::across(
        dplyr::everything(),
        list(
          AVG = ~mean(.x, na.rm = T),
          SUM = ~sum(.x, na.rm = T)
        ),
        .names = "{.col}.{.fn}"
      )
    ) |>
    dplyr::mutate(
      perc_rf_feminino_aux_gas.AVG = qtd_rf_feminino_benef_aux_gas.AVG/qtd_fam_benef_aux_gas.AVG,
      perc_rf_feminino_aux_gas.SUM = qtd_rf_feminino_benef_aux_gas.SUM/qtd_fam_benef_aux_gas.SUM
    ) |>
    dplyr::ungroup() |>
    tidyr::pivot_longer(
      cols = -c(database, time_period, time, geo, geo_value),
      names_to = c(".value", "stats_name"),
      names_sep = "\\."
    ) |>
    tidyr::pivot_longer(
      cols = -c('database','time_period', 'time', 'geo', 'geo_value', "stats_name"),
      names_to = "variable_id",
      values_to = "stats_value"
    )

  # Calculando os dados a nível Country -----

  mds_auxgas_br <- mds_auxgas_2021_2024 |>
    dplyr::filter(
      stringr::str_detect(anomes, "\\d{4}12")
    ) |>
    dplyr::mutate(
      database = "mds_auxgas",
      time_period = "year",
      geo = "country",
      anomes = stringr::str_extract(anomes, "\\d{4}"),
      codigo_ibge = "0"
    ) |>
    dplyr::rename(
      geo_value = codigo_ibge,
      time = anomes
    ) |>
    dplyr::select(
      database,
      time_period,
      time,
      geo,
      geo_value,
      qtd_fam_benef_aux_gas,
      qtd_rf_feminino_benef_aux_gas
    ) |>
    dplyr::group_by(
      database, time_period, time, geo, geo_value
    ) |>
    dplyr::summarise(
      dplyr::across(
        dplyr::everything(),
        list(
          AVG = ~mean(.x, na.rm = T),
          SUM = ~sum(.x, na.rm = T)
        ),
        .names = "{.col}.{.fn}"
      )
    ) |>
    dplyr::mutate(
      perc_rf_feminino_aux_gas.AVG = qtd_rf_feminino_benef_aux_gas.AVG/qtd_fam_benef_aux_gas.AVG,
      perc_rf_feminino_aux_gas.SUM = qtd_rf_feminino_benef_aux_gas.SUM/qtd_fam_benef_aux_gas.SUM
    ) |>
    dplyr::ungroup() |>
    tidyr::pivot_longer(
      cols = -c(database, time_period, time, geo, geo_value),
      names_to = c(".value", "stats_name"),
      names_sep = "\\."
    ) |>
    tidyr::pivot_longer(
      cols = -c('database','time_period', 'time', 'geo', 'geo_value', "stats_name"),
      names_to = "variable_id",
      values_to = "stats_value"
    )

  mds_auxgas_summarized_by_vulnerability <- mds_auxgas_br |>
    dplyr::bind_rows(mds_auxgas_reg) |>
    dplyr::bind_rows(mds_auxgas_uf) |>
    dplyr::bind_rows(mds_auxgas_mun)

  mds_auxgas_summarized_by_vulnerability |> dplyr::glimpse()

  return(mds_auxgas_summarized_by_vulnerability)
}
