#' Creates ANEEL - SAMP Vulnerability
#'
#' This function reads the wider data version of ANEEL - SAMP and summarizes all
#' vulnerabilities in a uf, region, country per year for each vulnerability.
#'
#' @param aneel_samp_wider A dataframe of ANEEL - SAMP transformed in a wider version
#'
#' @returns A dataframe containing the summarization of the vulnerabilities in
#' geographic per year for each vulnerability
#' @export
#'
#' @examples
#' \dontrun{
#'   aneel_samp_summarized_by_vulnerabilities <- create_aneel_samp_vulnerability(
#'     aneel_samp_wider = aneel_samp_wider
#'   )
#' }
create_aneel_samp_vulnerability <- function(aneel_samp_wider){

  # Sumarizando os dados a nível UF
  aneel_samp_uf <- aneel_samp_wider |>
    dplyr::mutate(
      database = "aneel_samp",
      time_period = "year",
      geo = "uf"
    ) |>
    dplyr::rename(
      time = dat_competencia,
      geo_value = uf
    ) |>
    dplyr::relocate(
      database,
      time_period,
      time,
      geo,
      geo_value
    ) |>
    dplyr::mutate(
      .by = c(database, time_period, time, geo, geo_value, sig_agente_distribuidora),
      energia_te_dist = sum(energia_te_k_wh, na.rm = T)
    ) |>
    dplyr::mutate(
      .by = c(database, time_period, time, geo, geo_value),
      TE_sem_imposto_media = mean(TE_sem_imposto, na.rm = T),
      TE_com_imposto_media = mean(TE_com_imposto, na.rm = T),
      TE_social_sem_imposto_media = mean(TE_social_sem_imposto, na.rm = T),
      TE_social_com_imposto_media = mean(TE_social_com_imposto, na.rm = T),
      energia_te_geo = sum(energia_te_k_wh, na.rm = T),
      tarifa_media_com_imposto = sum(TE_com_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
      tarifa_media_sem_imposto = sum(TE_sem_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
      tarifa_social_media_com_imposto = sum(TE_social_com_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
      tarifa_social_media_sem_imposto = sum(TE_social_sem_imposto * energia_te_dist, na.rm = T)/energia_te_geo
    ) |>
    dplyr::group_by(
      database, time_period, time, geo, geo_value
    ) |>
    dplyr::summarise(
      TEE_sem_imposto.AVG = mean(TE_sem_imposto_media, na.rm = T),
      TEE_com_imposto.AVG = mean(TE_com_imposto_media, na.rm = T),
      TSEE_sem_imposto.AVG = mean(TE_social_sem_imposto_media, na.rm = T),
      TSEE_com_imposto.AVG = mean(TE_social_com_imposto_media, na.rm = T),
      tarifa_sem_imposto.AVG = mean(tarifa_media_sem_imposto, na.rm = T),
      tarifa_com_imposto.AVG = mean(tarifa_media_com_imposto, na.rm = T),
      tarifa_social_sem_imposto.AVG = mean(tarifa_social_media_sem_imposto, na.rm = T),
      tarifa_social_com_imposto.AVG = mean(tarifa_social_media_com_imposto, na.rm = T)
    ) |>
    dplyr::ungroup() |>
    tidyr::pivot_longer(
      cols = -c(database, time_period, time, geo, geo_value),
      names_to = c(".value", "stats_name"),
      names_sep = "\\."
    ) |>
    tidyr::pivot_longer(
      cols = -c(database, time_period, time, geo, geo_value, stats_name),
      names_to = "variable_id",
      values_to = "stats_value"
    ) |>
    dplyr::relocate(
      variable_id,
      .before = stats_name
    )

  # Sumarizando os dados a nível Regional
  aneel_samp_reg <- aneel_samp_wider |>
    dplyr::mutate(
      database = "aneel_samp",
      time_period = "year",
      geo = "region",
      uf = stringr::str_extract(uf, ".")
    ) |>
    dplyr::rename(
      time = dat_competencia,
      geo_value = uf
    ) |>
    dplyr::relocate(
      database,
      time_period,
      time,
      geo,
      geo_value
    ) |>
    dplyr::mutate(
      .by = c(database, time_period, time, geo, geo_value, sig_agente_distribuidora),
      energia_te_dist = sum(energia_te_k_wh, na.rm = T)
    ) |>
    dplyr::mutate(
      .by = c(database, time_period, time, geo, geo_value),
      TE_sem_imposto_media = mean(TE_sem_imposto, na.rm = T),
      TE_com_imposto_media = mean(TE_com_imposto, na.rm = T),
      TE_social_sem_imposto_media = mean(TE_social_sem_imposto, na.rm = T),
      TE_social_com_imposto_media = mean(TE_social_com_imposto, na.rm = T),
      energia_te_geo = sum(energia_te_k_wh, na.rm = T),
      tarifa_media_com_imposto = sum(TE_com_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
      tarifa_media_sem_imposto = sum(TE_sem_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
      tarifa_social_media_com_imposto = sum(TE_social_com_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
      tarifa_social_media_sem_imposto = sum(TE_social_sem_imposto * energia_te_dist, na.rm = T)/energia_te_geo
    ) |>
    dplyr::group_by(
      database, time_period, time, geo, geo_value
    ) |>
    dplyr::summarise(
      TEE_sem_imposto.AVG = mean(TE_sem_imposto_media, na.rm = T),
      TEE_com_imposto.AVG = mean(TE_com_imposto_media, na.rm = T),
      TSEE_sem_imposto.AVG = mean(TE_social_sem_imposto_media, na.rm = T),
      TSEE_com_imposto.AVG = mean(TE_social_com_imposto_media, na.rm = T),
      tarifa_sem_imposto.AVG = mean(tarifa_media_sem_imposto, na.rm = T),
      tarifa_com_imposto.AVG = mean(tarifa_media_com_imposto, na.rm = T),
      tarifa_social_sem_imposto.AVG = mean(tarifa_social_media_sem_imposto, na.rm = T),
      tarifa_social_com_imposto.AVG = mean(tarifa_social_media_com_imposto, na.rm = T)
    ) |>
    dplyr::ungroup() |>
    tidyr::pivot_longer(
      cols = -c(database, time_period, time, geo, geo_value),
      names_to = c(".value", "stats_name"),
      names_sep = "\\."
    ) |>
    tidyr::pivot_longer(
      cols = -c(database, time_period, time, geo, geo_value, stats_name),
      names_to = "variable_id",
      values_to = "stats_value"
    ) |>
    dplyr::relocate(
      variable_id,
      .before = stats_name
    )

  # Sumarizando os dados a nível Nacional
  aneel_samp_br <- aneel_samp_wider |>
    dplyr::mutate(
      database = "aneel_samp",
      time_period = "year",
      geo = "country",
      uf = "0"
    ) |>
    dplyr::rename(
      time = dat_competencia,
      geo_value = uf
    ) |>
    dplyr::relocate(
      database,
      time_period,
      time,
      geo,
      geo_value
    ) |>
    dplyr::mutate(
      .by = c(database, time_period, time, geo, geo_value, sig_agente_distribuidora),
      energia_te_dist = sum(energia_te_k_wh, na.rm = T)
    ) |>
    dplyr::mutate(
      .by = c(database, time_period, time, geo, geo_value),
      TE_sem_imposto_media = mean(TE_sem_imposto, na.rm = T),
      TE_com_imposto_media = mean(TE_com_imposto, na.rm = T),
      TE_social_sem_imposto_media = mean(TE_social_sem_imposto, na.rm = T),
      TE_social_com_imposto_media = mean(TE_social_com_imposto, na.rm = T),
      energia_te_geo = sum(energia_te_k_wh, na.rm = T),
      tarifa_media_com_imposto = sum(TE_com_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
      tarifa_media_sem_imposto = sum(TE_sem_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
      tarifa_social_media_com_imposto = sum(TE_social_com_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
      tarifa_social_media_sem_imposto = sum(TE_social_sem_imposto * energia_te_dist, na.rm = T)/energia_te_geo
    ) |>
    dplyr::group_by(
      database, time_period, time, geo, geo_value
    ) |>
    dplyr::summarise(
      TEE_sem_imposto.AVG = mean(TE_sem_imposto_media, na.rm = T),
      TEE_com_imposto.AVG = mean(TE_com_imposto_media, na.rm = T),
      TSEE_sem_imposto.AVG = mean(TE_social_sem_imposto_media, na.rm = T),
      TSEE_com_imposto.AVG = mean(TE_social_com_imposto_media, na.rm = T),
      tarifa_sem_imposto.AVG = mean(tarifa_media_sem_imposto, na.rm = T),
      tarifa_com_imposto.AVG = mean(tarifa_media_com_imposto, na.rm = T),
      tarifa_social_sem_imposto.AVG = mean(tarifa_social_media_sem_imposto, na.rm = T),
      tarifa_social_com_imposto.AVG = mean(tarifa_social_media_com_imposto, na.rm = T)
    ) |>
    dplyr::ungroup() |>
    tidyr::pivot_longer(
      cols = -c(database, time_period, time, geo, geo_value),
      names_to = c(".value", "stats_name"),
      names_sep = "\\."
    ) |>
    tidyr::pivot_longer(
      cols = -c(database, time_period, time, geo, geo_value, stats_name),
      names_to = "variable_id",
      values_to = "stats_value"
    ) |>
    dplyr::relocate(
      variable_id,
      .before = stats_name
    )

  aneel_samp_summarized_by_vulnerabilities <- dplyr::bind_rows(aneel_samp_br, aneel_samp_reg) |>
    dplyr::bind_rows(aneel_samp_uf)

  aneel_samp_summarized_by_vulnerabilities |> dplyr::glimpse()

  return(aneel_samp_summarized_by_vulnerabilities)

}
