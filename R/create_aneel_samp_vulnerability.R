#' Creates ANEEL - SAMP Vulnerability
#'
#' This function reads the wider data version of ANEEL - SAMP and summarizes all
#' vulnerabilities in a uf, region, country per year for each vulnerability.
#'
#' @param aneel_samp_wider A dataframe of ANEEL - SAMP transformed in a wider version
#'
#' @returns A dataframe containing the summarization of the vulnerabilities in
#' geographic per year for each vulnerability
#' @export
#'
#' @examples
#' \dontrun{
#'   aneel_samp_summarized_by_vulnerabilities <- create_aneel_samp_vulnerability(
#'     aneel_samp_wider = aneel_samp_wider
#'   )
#' }
create_aneel_samp_vulnerability <- function(aneel_samp_wider){

  # Função auxiliar para sumarizar por nível geográfico
  summarize_by_geo <- function(df, geo, geo_value_fn) {
    geo_value_fn <- rlang::as_function(geo_value_fn)

    df %>%
      dplyr::mutate(
        database = "aneel_samp",
        time_period = "year",
        geo = geo,
        geo_value = geo_value_fn(uf)
      ) |>
      dplyr::rename(
        time = dat_competencia,
      ) |>
      dplyr::relocate(
        database,
        time_period,
        time,
        geo,
        geo_value
      ) |>
      dplyr::mutate(
        .by = c(database, time_period, time, geo, geo_value, sig_agente_distribuidora),
        energia_te_dist = sum(energia_te_k_wh, na.rm = T)
      ) |>
      dplyr::mutate(
        .by = c(database, time_period, time, geo, geo_value),
        TE_sem_imposto_media = mean(TE_sem_imposto, na.rm = T),
        TE_com_imposto_media = mean(TE_com_imposto, na.rm = T),
        TE_social_sem_imposto_media = mean(TE_social_sem_imposto, na.rm = T),
        TE_social_com_imposto_media = mean(TE_social_com_imposto, na.rm = T),
        energia_te_geo = sum(energia_te_k_wh, na.rm = T),
        tarifa_media_com_imposto = sum(TE_com_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
        tarifa_media_sem_imposto = sum(TE_sem_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
        tarifa_social_media_com_imposto = sum(TE_social_com_imposto * energia_te_dist, na.rm = T)/energia_te_geo,
        tarifa_social_media_sem_imposto = sum(TE_social_sem_imposto * energia_te_dist, na.rm = T)/energia_te_geo
      ) |>
      dplyr::group_by(
        database, time_period, time, geo, geo_value
      ) |>
      dplyr::summarise(
        TEE_sem_imposto.AVG = mean(TE_sem_imposto_media, na.rm = T),
        TEE_com_imposto.AVG = mean(TE_com_imposto_media, na.rm = T),
        TSEE_sem_imposto.AVG = mean(TE_social_sem_imposto_media, na.rm = T),
        TSEE_com_imposto.AVG = mean(TE_social_com_imposto_media, na.rm = T),
        tarifa_sem_imposto.AVG = mean(tarifa_media_sem_imposto, na.rm = T),
        tarifa_com_imposto.AVG = mean(tarifa_media_com_imposto, na.rm = T),
        tarifa_social_sem_imposto.AVG = mean(tarifa_social_media_sem_imposto, na.rm = T),
        tarifa_social_com_imposto.AVG = mean(tarifa_social_media_com_imposto, na.rm = T)
      ) |>
      dplyr::ungroup() |>
      tidyr::pivot_longer(
        cols = -c(database, time_period, time, geo, geo_value),
        names_to = c(".value", "stats_name"),
        names_sep = "\\."
      ) |>
      tidyr::pivot_longer(
        cols = -c(database, time_period, time, geo, geo_value, stats_name),
        names_to = "variable_id",
        values_to = "stats_value"
      ) |>
      dplyr::relocate(
        variable_id,
        .before = stats_name
      )
  }

  # Calculando as tarifas de cada Distribuidora
  aneel_samp <- aneel_samp_wider |>
    dplyr::mutate(
      dsc_sub_classe_consumidor = stringr::str_replace(dsc_sub_classe_consumidor,
                                                       "Residencial baixa renda – faixa \\d{2}",
                                                       "Residencial baixa renda")
    ) |>
    dplyr::group_by(
      database, time_period, dat_competencia, uf, sig_agente_distribuidora, dsc_modalidade_tarifaria,
      dsc_sub_grupo_tarifario, dsc_classe_consumo_mercado, dsc_sub_classe_consumidor
    ) |>
    dplyr::summarise(
      dplyr::across(
        c(energia_te_k_wh, icms_r, receita_energia_r, cofins_r, pis_pasep_r, receita_bandeiras_r),
        ~ sum(.x)
      )
    ) |>
    dplyr::ungroup() |>
    dplyr::mutate(
      TE_sem_imposto = ifelse(dsc_sub_classe_consumidor == "Residencial",
                              (receita_energia_r + receita_bandeiras_r)/energia_te_k_wh,
                              NA),
      TE_com_imposto = ifelse(dsc_sub_classe_consumidor == "Residencial",
                              (receita_energia_r+receita_bandeiras_r+pis_pasep_r+cofins_r+icms_r)/energia_te_k_wh,
                              NA),
      TE_social_sem_imposto = ifelse(dsc_sub_classe_consumidor != "Residencial",
                                     (receita_energia_r + receita_bandeiras_r)/energia_te_k_wh,
                                     NA),
      TE_social_com_imposto = ifelse(dsc_sub_classe_consumidor != "Residencial",
                                     (receita_energia_r+receita_bandeiras_r+pis_pasep_r+cofins_r+icms_r)/energia_te_k_wh,
                                     NA)
    )

  aneel_samp_br <- summarize_by_geo(aneel_samp, "country", ~ "0")
  aneel_samp_reg <- summarize_by_geo(aneel_samp, "region", ~ stringr::str_extract(., "."))
  aneel_samp_uf <- summarize_by_geo(aneel_samp, "uf", identity)

  aneel_samp_summarized_by_vulnerabilities <- dplyr::bind_rows(aneel_samp_br, aneel_samp_reg) |>
    dplyr::bind_rows(aneel_samp_uf)

  aneel_samp_summarized_by_vulnerabilities |> dplyr::glimpse()

  return(aneel_samp_summarized_by_vulnerabilities)

}
