#' Creates Aneel - Perdas Vulnerability
#'
#' This function read the data from Aneel - Relatório de Perdas de Energia compared
#' data and summarizes all vulnerabilities at UF, region, and country view per stats.
#'
#' @param dir Directory where the data from Aneel - Relatório de Perdas de Energia compared
#' data has been downloaded.
#'
#' @returns A dataframe
#' @export
#'
#' @examples
#' \dontrun{
#'   aneel_perdas_summarized_by_vulnerability <- create_aneel_perdas_vulnerability(
#'     dir = "data_aneel"
#'   )
#' }
create_aneel_perdas_vulnerability <- function(dir = "data_raw/aneel_perdas/"){

  # Carregando os dados
  aneel_perdas <- list.files(dir,
                             full.names = T) |>
    readxl::read_xlsx() |>
    janitor::clean_names() |>
    tidyr::drop_na(ano) |>
    dplyr::mutate(
      uf = dplyr::case_match(
        uf,
        "RO" ~ "11",
        "AC" ~ "12",
        "AM" ~ "13",
        "RR" ~ "14",
        "PA" ~ "15",
        "AP" ~ "16",
        "TO" ~ "17",
        "MA" ~ "21",
        "PI" ~ "22",
        "CE" ~ "23",
        "RN" ~ "24",
        "PB" ~ "25",
        "PE" ~ "26",
        "AL" ~ "27",
        "SE" ~ "28",
        "BA" ~ "29",
        "MG" ~ "31",
        "ES" ~ "32",
        "RJ" ~ "33",
        "SP" ~ "35",
        "PR" ~ "41",
        "SC" ~ "42",
        "RS" ~ "43",
        "MS" ~ "50",
        "MT" ~ "51",
        "GO" ~ "52",
        "DF" ~ "53"
      ),
      regiao = dplyr::case_match(regiao,
                                 "NORTE" ~ "1",
                                 "NORDESTE" ~ "2",
                                 "CENTRO OESTE" ~ "3",
                                 "SUDESTE" ~ "4",
                                 "SUL" ~ "5")
    )

  # Calculando as Vulnerabilidades a nível UF
  aneel_perdas_uf <- aneel_perdas |>
    dplyr::mutate(
      database = "aneel_perdas",
      time_period = "year",
      geo = "uf",
      ano = as.character(ano)
    ) |>
    dplyr::rename(
      time = ano,
      geo_value = uf
    ) |>
    dplyr::select(-c(energia_injetada_m_wh, distribuidora, regiao)) |>
    dplyr::group_by(
      database, time_period, time, geo, geo_value
    ) |>
    dplyr::summarise(
      dplyr::across(
        everything(),
        list(
          SUM = ~sum(.x, na.rm = T),
          AVG = ~mean(.x, na.rm = T)
        ),
        .names = "{.col}.{.fn}"
      )
    ) |>
    dplyr::mutate(
      perc_pnt_reg_sobre_bt.SUM = perda_nao_tecnica_regulatoria_m_wh.SUM/mercado_bt_m_wh.SUM,
      perc_pnt_reg_sobre_bt.AVG = perda_nao_tecnica_regulatoria_m_wh.AVG/mercado_bt_m_wh.AVG,
      perc_pnt_real_sobre_bt.SUM = perda_nao_tecnica_real_m_wh.SUM/mercado_bt_m_wh.SUM,
      perc_pnt_real_sobre_bt.AVG = perda_nao_tecnica_real_m_wh.AVG/mercado_bt_m_wh.AVG
    ) |>
    dplyr::ungroup() |>
    tidyr::pivot_longer(
      cols = -c('database','time_period', 'time', 'geo', 'geo_value'),
      names_to = c(".value", "stats_name"),
      names_sep = "\\."
    ) |>
    tidyr::pivot_longer(
      cols = -c('database','time_period', 'time', 'geo', 'geo_value', "stats_name"),
      names_to = "variable_id",
      values_to = "stats_value"
    ) |>
    dplyr::relocate(
      variable_id,
      .before = stats_name
    )

  # Calculando as Vulnerabilidades a nível Regional
  aneel_perdas_reg <- aneel_perdas |>
    dplyr::mutate(
      database = "aneel_perdas",
      time_period = "year",
      geo = "region",
      ano = as.character(ano)
    ) |>
    dplyr::rename(
      time = ano,
      geo_value = regiao
    ) |>
    dplyr::select(-c(energia_injetada_m_wh, distribuidora, uf)) |>
    dplyr::group_by(
      database, time_period, time, geo, geo_value
    ) |>
    dplyr::summarise(
      dplyr::across(
        everything(),
        list(
          SUM = ~sum(.x, na.rm = T),
          AVG = ~mean(.x, na.rm = T)
        ),
        .names = "{.col}.{.fn}"
      )
    ) |>
    dplyr::mutate(
      perc_pnt_reg_sobre_bt.SUM = perda_nao_tecnica_regulatoria_m_wh.SUM/mercado_bt_m_wh.SUM,
      perc_pnt_reg_sobre_bt.AVG = perda_nao_tecnica_regulatoria_m_wh.AVG/mercado_bt_m_wh.AVG,
      perc_pnt_real_sobre_bt.SUM = perda_nao_tecnica_real_m_wh.SUM/mercado_bt_m_wh.SUM,
      perc_pnt_real_sobre_bt.AVG = perda_nao_tecnica_real_m_wh.AVG/mercado_bt_m_wh.AVG
    ) |>
    dplyr::ungroup() |>
    tidyr::pivot_longer(
      cols = -c('database','time_period', 'time', 'geo', 'geo_value'),
      names_to = c(".value", "stats_name"),
      names_sep = "\\."
    ) |>
    tidyr::pivot_longer(
      cols = -c('database','time_period', 'time', 'geo', 'geo_value', "stats_name"),
      names_to = "variable_id",
      values_to = "stats_value"
    ) |>
    dplyr::relocate(
      variable_id,
      .before = stats_name
    )
  # Calculando as Vulnerabilidades a nível Nacional
  aneel_perdas_br <- aneel_perdas |>
    dplyr::mutate(
      database = "aneel_perdas",
      time_period = "year",
      geo = "country",
      geo_value = "0",
      ano = as.character(ano)
    ) |>
    dplyr::rename(
      time = ano,
    ) |>
    dplyr::select(-c(energia_injetada_m_wh, distribuidora, uf, regiao)) |>
    dplyr::group_by(
      database, time_period, time, geo, geo_value
    ) |>
    dplyr::summarise(
      dplyr::across(
        everything(),
        list(
          SUM = ~sum(.x, na.rm = T),
          AVG = ~mean(.x, na.rm = T)
        ),
        .names = "{.col}.{.fn}"
      )
    ) |>
    dplyr::mutate(
      perc_pnt_reg_sobre_bt.SUM = perda_nao_tecnica_regulatoria_m_wh.SUM/mercado_bt_m_wh.SUM,
      perc_pnt_reg_sobre_bt.AVG = perda_nao_tecnica_regulatoria_m_wh.AVG/mercado_bt_m_wh.AVG,
      perc_pnt_real_sobre_bt.SUM = perda_nao_tecnica_real_m_wh.SUM/mercado_bt_m_wh.SUM,
      perc_pnt_real_sobre_bt.AVG = perda_nao_tecnica_real_m_wh.AVG/mercado_bt_m_wh.AVG
    ) |>
    dplyr::ungroup() |>
    tidyr::pivot_longer(
      cols = -c('database','time_period', 'time', 'geo', 'geo_value'),
      names_to = c(".value", "stats_name"),
      names_sep = "\\."
    ) |>
    tidyr::pivot_longer(
      cols = -c('database','time_period', 'time', 'geo', 'geo_value', "stats_name"),
      names_to = "variable_id",
      values_to = "stats_value"
    ) |>
    dplyr::relocate(
      variable_id,
      .before = stats_name
    )

  aneel_perdas_summarized_by_vulnerability <- aneel_perdas_br |>
    dplyr::bind_rows(aneel_perdas_reg) |>
    dplyr::bind_rows(aneel_perdas_uf)

  aneel_perdas_summarized_by_vulnerability |> dplyr::glimpse()

  return(aneel_perdas_summarized_by_vulnerability)
}
