#' Create INMET Vulnerabilities
#'
#' This function reads the data from INMET (Instituto Nacional de Meteriologia)
#' and summarizes all vulnerabilies at UF, region and country view per stats.
#'
#' @returns A dataframe.
#' @export
#'
#' @examples
#' \dontrun{
#'   inmet_summarized_by_vulnerability <- create_inmet_vulnerability()
#' }
create_inmet_vulnerability <- function(){

  # Vulnerabilidades INMET ---
  geo_codes <- geobr::read_state()

  data_inmet <- bidexpansaoenergetica::inmet_tabela_temp |>
    dplyr::inner_join(geo_codes |>
                        dplyr::select(abbrev_state, code_state, code_region),
                      by = c("uf_abr" = "abbrev_state"))

  # Clima para UF
  climauf <- data_inmet |>
    dplyr::select(code_region,
                  time = date,
                  geo_value = code_state,
                  # stats_value_ponderado = t_mean_annual,
                  stats_value = t_mean_annual,
                  t_mean_annual_cut) |>
    dplyr::mutate(time_period = "year",
                  geo = "uf",
                  variable_id = "TEMP",
                  stats_name = "AVG",
                  stats_value_amostra = NA,
                  stats_category = as.numeric(t_mean_annual_cut))

  # Função para vetorizar
  categ <- Vectorize(function(x) {
    c0 <- climauf |>
      dplyr::group_by(stats_category) |>
      dplyr::summarise(min = min(stats_value),
                       max = max(stats_value),
                       .groups = "drop") |>
      dplyr::arrange(min) |>
      dplyr::filter(max > x) |>
      dplyr::slice(1) |>
      dplyr::pull(stats_category)
    ifelse(length(c0) == 0, 4, c0)
  })

  # Clima para Região
  climareg <-
    climauf |>
    dplyr::mutate(geo_value = code_region,
                  geo = "region") |>
    dplyr::group_by(geo, geo_value, time, time_period, variable_id, stats_name) |>
    dplyr::summarise(stats_value_amostra = ifelse(is.nan(mean(stats_value_amostra, na.rm = TRUE)),
                                                  NA,
                                                  mean(stats_value_amostra, na.rm = TRUE)),
                     stats_value = mean(stats_value, na.rm = TRUE),
                     .groups = "drop") |>
    dplyr::mutate(stats_category = categ(stats_value))

  # Clima para o Brasil
  climacountry <- climareg |>
    dplyr::mutate(geo_value = 0,
                  geo = "country") |>
    dplyr::group_by(geo, geo_value, time, time_period, variable_id, stats_name) |>
    dplyr::summarise(stats_value_amostra = ifelse(is.nan(mean(stats_value_amostra, na.rm = TRUE)),
                                                  NA,
                                                  mean(stats_value_amostra, na.rm = TRUE)),
                     stats_value = mean(stats_value, na.rm = TRUE),
                     .groups = "drop") |>
    dplyr::mutate(stats_category = categ(stats_value))

  # Tabela Final
  inmet_summarized_by_vulnerability <-
    dplyr::bind_rows(climacountry,
                     climareg,
                     climauf |>
                       dplyr::select(-code_region, -t_mean_annual_cut)) |>
    dplyr::mutate(geo_value = as.character(geo_value),
                  stats_category = as.character(stats_category),
                  database = "inmet",
    ) |>
    dplyr::select(-stats_value_amostra)

  return(inmet_summarized_by_vulnerability)

}
